<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Asteroid Impact Simulator - Interactive Learning Experience</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        :root {
            --nasa-blue: #0B3D91;
            --nasa-red: #FC3D21;
            --nasa-white: #ffffff;
            --nasa-gray: #d9d9d9;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #533483 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(135deg, rgba(11,61,145,0.85), rgba(0,0,0,0.6));
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.12);
        }

        .header h1 {
            font-size: 3.2rem;
            margin-bottom: 10px;
            color: var(--nasa-white);
            letter-spacing: 0.5px;
        }

        .nasa-branding {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 10px;
        }

        .nasa-branding img {
            height: 48px;
            width: 48px;
        }

        .mission-chips {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .chip {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.25);
            background: rgba(255,255,255,0.08);
            color: var(--nasa-white);
            font-size: 12px;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .data-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .data-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .data-card h3 {
            color: #4ecdc4;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .metric:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.02);
        }

        .metric .value {
            color: #ff6b6b;
            font-weight: 700;
            font-size: 1.1rem;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .panel h3 {
            color: #4ecdc4;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .globe-container {
            height: 500px;
            background: radial-gradient(circle at center, rgba(0, 50, 100, 0.3) 0%, rgba(0, 0, 0, 0.8) 100%);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .earth {
            width: 280px;
            height: 280px;
            background: linear-gradient(45deg, #4A90E2, #2E5BBA, #1e3c72);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: rotate 40s linear infinite;
            box-shadow: 
                0 0 80px rgba(74, 144, 226, 0.8),
                inset -20px -20px 40px rgba(0, 0, 0, 0.3),
                inset 20px 20px 40px rgba(255, 255, 255, 0.1);
        }

        .earth::before {
            content: '';
            position: absolute;
            top: 15%;
            left: 25%;
            width: 45%;
            height: 35%;
            background: linear-gradient(45deg, #228B22, #32CD32);
            border-radius: 50%;
            opacity: 0.9;
            animation: continentPulse 6s ease-in-out infinite;
        }

        .earth::after {
            content: '';
            position: absolute;
            top: 55%;
            right: 15%;
            width: 35%;
            height: 30%;
            background: linear-gradient(45deg, #228B22, #32CD32);
            border-radius: 50%;
            opacity: 0.7;
            animation: continentPulse 6s ease-in-out infinite 3s;
        }

        @keyframes continentPulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        @keyframes rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .orbit {
            position: absolute;
            width: 450px;
            height: 450px;
            border: 3px solid #ff6b6b;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.9;
            animation: orbit 20s linear infinite;
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.5);
        }

        @keyframes orbit {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .asteroid {
            position: absolute;
            width: 15px;
            height: 15px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            border-radius: 50%;
            top: -7.5px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 
                0 0 20px #ff6b6b,
                0 0 40px rgba(255, 107, 107, 0.5);
            animation: asteroidPulse 2s infinite;
        }

        @keyframes asteroidPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.4); }
        }

        .uncertainty-heatmap {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 15px;
            opacity: 0.7;
            z-index: 2; /* ensure visible above orbit and earth */
            pointer-events: none;
            background: radial-gradient(circle, rgba(255, 0, 0, 0.4) 0%, rgba(255, 165, 0, 0.3) 50%, rgba(0, 255, 0, 0.2) 100%);
            animation: heatmapPulse 4s ease-in-out infinite;
        }

        @keyframes heatmapPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        .map-container {
            height: 500px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 400; /* above leaflet tiles */
        }

        .impact-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #ff6b6b, #ff0000);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 
                0 0 30px #ff6b6b,
                0 0 60px rgba(255, 107, 107, 0.5);
            animation: impactPulse 1.5s infinite;
        }

        @keyframes impactPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.5); }
        }

        .crater-zone {
            position: absolute;
            width: 150px;
            height: 150px;
            border: 4px solid #8B4513;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.7;
            animation: craterGlow 3s ease-in-out infinite;
        }

        @keyframes craterGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 69, 19, 0.5); }
            50% { box-shadow: 0 0 40px rgba(139, 69, 19, 0.8); }
        }

        .tsunami-zone {
            position: absolute;
            width: 300px;
            height: 300px;
            border: 4px solid #00bfff;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.6;
            animation: tsunamiWave 4s ease-in-out infinite;
        }

        @keyframes tsunamiWave {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.4; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; }
        }

        .seismic-wave {
            position: absolute;
            width: 350px;
            height: 350px;
            border: 3px solid #ffa500;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.4;
            animation: seismicPulse 2s infinite;
        }

        @keyframes seismicPulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(1.8); opacity: 0; }
        }

        .population-density {
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255, 0, 0, 0.4) 0%, rgba(255, 0, 0, 0.2) 50%, transparent 100%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            animation: populationPulse 5s ease-in-out infinite;
        }

        @keyframes populationPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        .controls-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .control-section {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .control-group {
            margin-bottom: 25px;
            position: relative;
        }

        .control-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #4ecdc4;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.3));
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.6);
            transition: all 0.3s ease;
        }

        .deflection-method {
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .deflection-method:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .deflection-method.active {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
            box-shadow: 0 0 30px rgba(78, 205, 196, 0.3);
        }

        .deflection-method h4 {
            color: #4ecdc4;
            margin-bottom: 10px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--nasa-red), #ff7b5c);
            color: white;
            box-shadow: 0 5px 15px rgba(252, 61, 33, 0.35);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.6);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.35);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f1c40f, #f39c12);
            color: white;
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.35);
        }

        .source-badges {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 8px;
            font-size: 12px;
        }

        .source-badges .badge {
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.18);
            color: var(--nasa-gray);
        }

        /* Toasts */
        .toast-container {
            position: fixed;
            right: 20px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        .toast {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
            font-size: 14px;
        }

        .chart-container {
            height: 300px;
            margin: 25px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .real-time-data {
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid #00ff00;
            border-radius: 15px;
            padding: 20px;
            margin: 25px 0;
            position: relative;
            overflow: hidden;
        }

        .real-time-data h4 {
            color: #00ff00;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-stream {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid rgba(0, 255, 0, 0.3);
        }

        .educational-snippet {
            background: rgba(78, 205, 196, 0.1);
            border: 2px solid #4ecdc4;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .educational-snippet::before {
            content: '💡';
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            animation: sparkle 2s infinite;
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
        }

        .educational-snippet h4 {
            color: #4ecdc4;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .educational-snippet p {
            font-size: 14px;
            line-height: 1.6;
            opacity: 0.9;
        }

        .policy-brief {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .policy-brief h3 {
            color: #4ecdc4;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .policy-brief .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .policy-brief .metric:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.02);
        }

        @media (max-width: 1200px) {
            .main-grid, .controls-panel, .data-dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Starfield Background -->
    <div class="stars" id="stars"></div>

    <div class="container">
        <!-- Enhanced Header -->
        <div class="header">
            <div class="nasa-branding">
                <img src="https://www.nasa.gov/wp-content/themes/nasa/assets/images/nasa-logo.svg" alt="NASA logo" />
                <h1>Planetary Defense Simulator</h1>
            </div>
            <p>Powered by NASA data sources • Mission Control Aesthetics</p>
            <div class="mission-chips">
                <span class="chip">DART Mission</span>
                <span class="chip">PDCO</span>
                <span class="chip">Sentry-II</span>
                <span class="chip">JPL Horizons</span>
            </div>
            <div class="source-badges" aria-label="Data sources">
                <span class="badge">NEO WS</span>
                <span class="badge">JPL Sentry</span>
                <span class="badge">USGS</span>
            </div>
            <div class="educational-snippet">
                <h4>🌍 How It Works</h4>
                <p>This simulator uses real NASA data and advanced physics to model asteroid impacts. Watch as orbital mechanics, impact energy, and deflection strategies come to life through interactive visualizations!</p>
            </div>
        </div>

        <!-- Enhanced Data Dashboard -->
        <div class="data-dashboard">
            <div class="data-card">
                <h3><i class="fas fa-globe-americas"></i> Real-time Orbital Data</h3>
                <div class="metric">
                    <span class="label"><i class="fas fa-circle"></i> Semi-Major Axis:</span>
                    <span class="value" id="semiMajorValue">1.5 AU</span>
                </div>
                <div class="metric">
                    <span class="label"><i class="fas fa-ellipsis-h"></i> Eccentricity:</span>
                    <span class="value" id="eccentricityValue">0.3</span>
                </div>
                <div class="metric">
                    <span class="label"><i class="fas fa-angle-up"></i> Inclination:</span>
                    <span class="value" id="inclinationValue">15°</span>
                </div>
                <div class="metric">
                    <span class="label"><i class="fas fa-tachometer-alt"></i> Velocity:</span>
                    <span class="value" id="velocityValue">20.0 km/s</span>
                </div>
            </div>

            <div class="data-card">
                <h3><i class="fas fa-chart-line"></i> Impact Predictions</h3>
                <div class="metric">
                    <span class="label"><i class="fas fa-bullseye"></i> Miss Distance:</span>
                    <span class="value" id="missDistanceValue">5000 km</span>
                </div>
                <div class="metric">
                    <span class="label"><i class="fas fa-bolt"></i> Impact Energy:</span>
                    <span class="value" id="energyValue">287 MT TNT</span>
                </div>
                <div class="metric">
                    <span class="label"><i class="fas fa-circle"></i> Crater Diameter:</span>
                    <span class="value" id="craterValue">2.5 km</span>
                </div>
                <div class="metric">
                    <span class="label"><i class="fas fa-water"></i> Tsunami Radius:</span>
                    <span class="value" id="tsunamiValue">45 km</span>
                </div>
            </div>

            <div class="data-card">
                <h3><i class="fas fa-users"></i> Population Impact</h3>
                <div class="metric">
                    <span class="label"><i class="fas fa-map-marker-alt"></i> Population Density:</span>
                    <span class="value" id="populationDensityValue">1000/km²</span>
                </div>
                <div class="metric">
                    <span class="label"><i class="fas fa-exclamation-triangle"></i> Affected Population:</span>
                    <span class="value" id="affectedPopulationValue">1.4M</span>
                </div>
                <div class="metric">
                    <span class="label"><i class="fas fa-heart-broken"></i> Estimated Casualties:</span>
                    <span class="value" id="casualtyCount">140K</span>
                </div>
                <div class="metric">
                    <span class="label"><i class="fas fa-mountain"></i> Seismic Intensity:</span>
                    <span class="value" id="seismicValue">VII (Strong)</span>
                </div>
            </div>
        </div>

        <!-- Enhanced Main Grid -->
        <div class="main-grid">
            <div class="panel">
                <h3><i class="fas fa-globe"></i> 3D Orbital Trajectory</h3>
                <div class="globe-container">
                    <div class="uncertainty-heatmap" id="uncertaintyHeatmap"></div>
                    <div class="orbit">
                        <div class="asteroid"></div>
                    </div>
                    <div class="earth"></div>
                </div>
                <div class="chart-container">
                    <canvas id="orbitalChart"></canvas>
                </div>
                <div class="educational-snippet">
                    <h4>🛰️ Orbital Mechanics</h4>
                    <p>The asteroid follows Kepler's laws of planetary motion. Watch how its elliptical orbit brings it closer to Earth over time!</p>
                </div>
            </div>

            <div class="panel">
                <h3><i class="fas fa-map-marked-alt"></i> Impact Zone & Risk Assessment</h3>
                <div class="map-container" style="height: 400px; position: relative;">
                    <div id="impactMap" style="height: 100%;"></div>
                    <div class="map-overlay">
                        <div class="population-density"></div>
                        <div class="seismic-wave"></div>
                        <div class="tsunami-zone"></div>
                        <div class="crater-zone"></div>
                        <div class="impact-marker"></div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="riskChart"></canvas>
                </div>
                <div class="educational-snippet">
                    <h4>💥 Impact Physics</h4>
                    <p>When an asteroid hits Earth, it creates a crater, generates seismic waves, and can trigger tsunamis. The size depends on the asteroid's mass and velocity!</p>
                </div>
            </div>
        </div>

        <!-- Enhanced Controls -->
        <div class="controls-panel">
            <div class="control-section">
                <h3><i class="fas fa-satellite"></i> Orbital Parameters</h3>
                
                <div class="control-group">
                    <label for="neoId"><i class="fas fa-search"></i> NASA NEO ID:</label>
                    <input type="text" id="neoId" value="3722520" placeholder="e.g., 3542519" aria-label="NASA Near-Earth Object ID" style="width: 100%; padding: 12px; border-radius: 8px; border: none; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                </div>

                <div class="control-group">
                </div>

                <div class="control-group">
                    <label for="semiMajorAxis"><i class="fas fa-circle"></i> Semi-Major Axis: <span id="semiMajorSliderValue">1.5</span> AU</label>
                    <input type="range" id="semiMajorAxis" class="slider" min="0.5" max="3" step="0.1" value="1.5" oninput="updateOrbitalElementsDebounced()">
                </div>

                <div class="control-group">
                    <label for="eccentricity"><i class="fas fa-ellipsis-h"></i> Eccentricity: <span id="eccentricitySliderValue">0.3</span></label>
                    <input type="range" id="eccentricity" class="slider" min="0" max="0.9" step="0.01" value="0.3" oninput="updateOrbitalElementsDebounced()">
                </div>

                <div class="control-group">
                    <label for="inclination"><i class="fas fa-angle-up"></i> Inclination: <span id="inclinationSliderValue">15</span>°</label>
                    <input type="range" id="inclination" class="slider" min="0" max="180" value="15" oninput="updateOrbitalElementsDebounced()">
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="fetchRealData()" aria-live="polite">
                        <i class="fas fa-sync-alt"></i> Fetch Real Data (NASA)
                    </button>
                    <button class="btn btn-success" onclick="startDemoMode()" title="Run a guided demo for hackathon judges">
                        <i class="fas fa-play"></i> Demo Mode
                    </button>
                    <button class="btn btn-secondary" onclick="updateUncertaintyHeatmap()">
                        <i class="fas fa-fire"></i> Update Heatmap
                    </button>
                </div>
            </div>

            <div class="control-section">
                <h3><i class="fas fa-shield-alt"></i> Deflection Strategies</h3>
                
                <div class="deflection-method active" onclick="selectDeflectionMethod('kinetic')">
                    <h4><i class="fas fa-rocket"></i> Kinetic Impactor</h4>
                    <p>High-speed collision to alter trajectory - like hitting a billiard ball!</p>
                    <div class="control-group">
                        <label for="impactorMass"><i class="fas fa-weight"></i> Mass: <span id="impactorMassValue">1000</span> kg</label>
                        <input type="range" id="impactorMass" class="slider" min="100" max="10000" value="1000" oninput="updateDeflectionParams()">
                    </div>
                    <div class="control-group">
                        <label for="impactorVelocity"><i class="fas fa-tachometer-alt"></i> Velocity: <span id="impactorVelocityValue">10</span> km/s</label>
                        <input type="range" id="impactorVelocity" class="slider" min="5" max="20" step="0.5" value="10" oninput="updateDeflectionParams()">
                    </div>
                </div>

                <div class="deflection-method" onclick="selectDeflectionMethod('gravity')">
                    <h4><i class="fas fa-satellite"></i> Gravity Tractor</h4>
                    <p>Gravitational attraction over time - like a cosmic tug-of-war!</p>
                    <div class="control-group">
                        <label for="tractorMass"><i class="fas fa-weight"></i> Mass: <span id="tractorMassValue">5000</span> kg</label>
                        <input type="range" id="tractorMass" class="slider" min="1000" max="50000" value="5000" oninput="updateDeflectionParams()">
                    </div>
                    <div class="control-group">
                        <label for="hoverDistance"><i class="fas fa-ruler"></i> Distance: <span id="hoverDistanceValue">100</span> m</label>
                        <input type="range" id="hoverDistance" class="slider" min="50" max="500" value="100" oninput="updateDeflectionParams()">
                    </div>
                </div>

                <div class="deflection-method" onclick="selectDeflectionMethod('nuclear')">
                    <h4><i class="fas fa-bomb"></i> Nuclear Pulse</h4>
                    <p>Nuclear detonation for maximum deflection - last resort option!</p>
                    <div class="control-group">
                        <label for="nuclearYield"><i class="fas fa-fire"></i> Yield: <span id="nuclearYieldValue">1</span> MT</label>
                        <input type="range" id="nuclearYield" class="slider" min="0.1" max="10" step="0.1" value="1" oninput="updateDeflectionParams()">
                    </div>
                    <div class="control-group">
                        <label for="detonationAltitude"><i class="fas fa-mountain"></i> Altitude: <span id="detonationAltitudeValue">1000</span> m</label>
                        <input type="range" id="detonationAltitude" class="slider" min="100" max="5000" value="1000" oninput="updateDeflectionParams()">
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="applyDeflection()">
                        <i class="fas fa-play"></i> Apply Deflection
                    </button>
                    <button class="btn btn-secondary" onclick="resetSimulation()">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>

            <div class="control-section">
                <h3><i class="fas fa-broadcast-tower"></i> Real-time Data Stream</h3>
                <div class="real-time-data">
                    <h4><i class="fas fa-signal"></i> Live Data Feed</h4>
                    <div class="data-stream" id="dataStream">
                        <div><i class="fas fa-cog fa-spin"></i> System: Initializing data streams...</div>
                        <div><i class="fas fa-check-circle" style="color: #00ff00;"></i> NASA API: Connected</div>
                        <div><i class="fas fa-check-circle" style="color: #00ff00;"></i> USGS API: Connected</div>
                        <div><i class="fas fa-check-circle" style="color: #00ff00;"></i> Population Data: Loaded</div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-success" onclick="startDataStream()">
                        <i class="fas fa-play"></i> Start Stream
                    </button>
                    <button class="btn btn-warning" onclick="exportData()">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Policy Brief -->
        <div class="policy-brief">
            <h3><i class="fas fa-file-alt"></i> Policy Brief Summary</h3>
            <div class="metric">
                <span>Risk Level:</span>
                <span id="riskLevel">HIGH</span>
            </div>
            <div class="metric">
                <span>Recommended Action:</span>
                <span id="recommendedAction">Kinetic Impactor</span>
            </div>
            <div class="metric">
                <span>Success Probability:</span>
                <span id="successProbability">85%</span>
            </div>
            <div class="metric">
                <span>Cost Estimate:</span>
                <span id="costEstimate">$500M</span>
            </div>
            <div class="metric">
                <span>Time to Impact:</span>
                <span id="timeToImpact">7 days</span>
            </div>
        </div>
    </div>

    <!-- ARIA live region for screen readers -->
    <div id="ariaLive" aria-live="polite" aria-atomic="true" style="position: absolute; left: -9999px; top: -9999px;"></div>
    <!-- Toasts container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // WORKING JavaScript Functions
        let currentDeflectionMethod = 'kinetic';
        let charts = {};
        let isLoading = false;
        
        // Simple debounce utility
        function debounce(fn, delay) {
            let timer;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // Clamp helper to enforce min/max on inputs
        function clamp(value, min, max) {
            const n = Number(value);
            if (Number.isNaN(n)) return min;
            return Math.min(max, Math.max(min, n));
        }

        // Initialize everything when page loads
        window.onload = function() {
            createStarfield();
            initializeCharts();
            restoreState();
            updateOrbitalElements();
            addToDataStream('Advanced Asteroid Impact Simulator initialized');
            updateImpactVisualization();
            initializeImpactMap();
        };

        // Create animated starfield
        function createStarfield() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 3 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }

        // Working orbital elements update
        function updateOrbitalElements() {
    // Validate and clamp slider values
    const aInput = document.getElementById('semiMajorAxis');
    const eInput = document.getElementById('eccentricity');
    const iInput = document.getElementById('inclination');

    const a = clamp(aInput.value, parseFloat(aInput.min), parseFloat(aInput.max));
    const e = clamp(eInput.value, parseFloat(eInput.min), parseFloat(eInput.max));
    const i = clamp(iInput.value, parseFloat(iInput.min), parseFloat(iInput.max));

    // Normalize inputs if needed
    aInput.value = a;
    eInput.value = e;
    iInput.value = i;
    
    // Update dashboard display values
    document.getElementById('semiMajorValue').textContent = a.toFixed(1) + ' AU';
    document.getElementById('eccentricityValue').textContent = e.toFixed(2);
    document.getElementById('inclinationValue').textContent = i.toFixed(0) + '°';
    
    // Update slider label values next to controls
    const semiMajorSliderEl = document.getElementById('semiMajorSliderValue');
    if (semiMajorSliderEl) semiMajorSliderEl.textContent = a.toFixed(1);
    const eccentricitySliderEl = document.getElementById('eccentricitySliderValue');
    if (eccentricitySliderEl) eccentricitySliderEl.textContent = e.toFixed(2);
    const inclinationSliderEl = document.getElementById('inclinationSliderValue');
    if (inclinationSliderEl) inclinationSliderEl.textContent = i.toFixed(0);
    
    // Update impact calculations
    calculateImpact();
    updateImpactVisualization();
    addToDataStream(`Orbital elements updated: a=${a}, e=${e}, i=${i}`);
    persistState();
}

        // Debounced wrapper to limit recalculations during slider drag
        const updateOrbitalElementsDebounced = debounce(updateOrbitalElements, 120);
        

        // Working deflection method selection
        function selectDeflectionMethod(method) {
            currentDeflectionMethod = method;
            
            // Update visual selection
            document.querySelectorAll('.deflection-method').forEach(m => m.classList.remove('active'));
            event.target.closest('.deflection-method').classList.add('active');
            
            addToDataStream(`Deflection method changed to: ${method}`);
        }

        // Working deflection parameters update
        function updateDeflectionParams() {
            const method = currentDeflectionMethod;
            
            if (method === 'kinetic') {
                const mass = document.getElementById('impactorMass').value;
                const velocity = document.getElementById('impactorVelocity').value;
                document.getElementById('impactorMassValue').textContent = mass;
                document.getElementById('impactorVelocityValue').textContent = velocity;
            } else if (method === 'gravity') {
                const mass = document.getElementById('tractorMass').value;
                const distance = document.getElementById('hoverDistance').value;
                document.getElementById('tractorMassValue').textContent = mass;
                document.getElementById('hoverDistanceValue').textContent = distance;
            } else if (method === 'nuclear') {
                const yield = document.getElementById('nuclearYield').value;
                const altitude = document.getElementById('detonationAltitude').value;
                document.getElementById('nuclearYieldValue').textContent = yield;
                document.getElementById('detonationAltitudeValue').textContent = altitude;
            }
            
            addToDataStream(`${method} parameters updated`);
        }

        // Working impact calculation
        function calculateImpact() {
            const diameter = 200; // Default asteroid diameter
            const aNowCalc = parseFloat(document.getElementById('semiMajorAxis').value);
            const velocity = aNowCalc * 10; // km/s, simplified relation for demo
            const angle = parseFloat(document.getElementById('inclination').value);
            
            // Calculate energy
            const mass = (Math.PI / 6) * 3000 * (diameter ** 3);
            const energy = 0.5 * mass * (velocity * 1000) ** 2;
            const energyMT = energy / 4.184e15;
            
            // Calculate crater diameter
            const angleRad = (Math.PI * angle) / 180;
            const craterDiameter = 1.8 * (energy ** 0.29) / 1000 * Math.sin(angleRad);
            
            // Calculate tsunami radius
            const tsunamiRadius = 50 * (energyMT ** 0.33);
            
            // Calculate casualties based on simple density model (people per km^2)
            const densityText = document.getElementById('populationDensityValue').textContent || '1000/km²';
            const density = parseFloat(densityText) || 1000; // people per km^2
            const affectedArea = Math.PI * (tsunamiRadius ** 2); // km^2
            const casualties = Math.floor(affectedArea * density * 0.08); // 8% rate heuristic
            
            // Update display (sync velocity as well)
            document.getElementById('velocityValue').textContent = velocity.toFixed(1) + ' km/s';
            document.getElementById('energyValue').textContent = energyMT.toFixed(1) + ' MT TNT';
            document.getElementById('craterValue').textContent = craterDiameter.toFixed(1) + ' km';
            document.getElementById('tsunamiValue').textContent = tsunamiRadius.toFixed(0) + ' km';
            document.getElementById('casualtyCount').textContent = casualties.toLocaleString();
            
            // Update miss distance (make responsive to both a and e)
            const aNow = parseFloat(document.getElementById('semiMajorAxis').value);
            const eNow = parseFloat(document.getElementById('eccentricity').value);
            const missDistance = Math.max(0, 2000 + (eNow * 8000) + ((aNow - 1.5) * 2000));
            document.getElementById('missDistanceValue').textContent = missDistance.toFixed(0) + ' km';

            // Update dynamic time to impact using a simple t = distance / closing velocity
            const iRad = (Math.PI * angle) / 180;
            const closingVelocityKms = Math.max(0.5, Math.abs(velocity * Math.cos(iRad)) * (1 + eNow * 0.2));
            const timeSeconds = Math.max(0, missDistance) / closingVelocityKms; // km / (km/s) => seconds
            let timeLabel = '';
            const days = Math.floor(timeSeconds / 86400);
            const hours = Math.floor((timeSeconds % 86400) / 3600);
            if (days >= 1) {
                timeLabel = days + 'd ' + hours + 'h';
            } else {
                const minutes = Math.max(1, Math.floor((timeSeconds % 3600) / 60));
                timeLabel = hours + 'h ' + minutes + 'm';
            }
            document.getElementById('timeToImpact').textContent = timeLabel;

            // Update policy recommendation based on latest values
            updatePolicyRecommendation();

            // Update charts with current values
            updateCharts({
                energyMt: energyMT,
                craterDiameter,
                tsunamiRadius,
                missDistance,
                semiMajorAxis: parseFloat(document.getElementById('semiMajorAxis').value),
                eccentricity: parseFloat(document.getElementById('eccentricity').value)
            });
        }

        // Update charts dynamically based on current parameters
        function updateCharts(params) {
            if (!charts || !charts.orbital || !charts.risk) return;

            const { energyMt, craterDiameter, tsunamiRadius, missDistance, semiMajorAxis, eccentricity } = params;

            // Orbital chart: simple trend from apoapsis-ish distance toward miss distance
            const startKm = Math.max(100000, (semiMajorAxis * (1 + Math.max(0, eccentricity))) * 1000000);
            const endKm = Math.max(0, missDistance);
            const steps = charts.orbital.data.labels.length || 8;
            const distances = [];
            for (let i = 0; i < steps; i++) {
                const t = i / (steps - 1);
                const eased = 1 - Math.pow(1 - t, 2); // ease-out
                const value = startKm + (endKm - startKm) * eased;
                distances.push(Math.max(0, Math.round(value)));
            }
            charts.orbital.data.datasets[0].data = distances;
            charts.orbital.update('none');

            // Risk chart: robust composition (allow true zeros, sum to 100)
            const craterScore = Math.max(0, isFinite(craterDiameter) ? craterDiameter : 0);
            const tsunamiScore = Math.max(0, isFinite(tsunamiRadius) ? (tsunamiRadius / 2) : 0);
            const seismicScore = Math.max(0, isFinite(energyMt) ? (Math.sqrt(Math.max(0, energyMt)) / 2) : 0);
            let safeScore = 20;
            let total = craterScore + tsunamiScore + seismicScore + safeScore;
            if (total <= 0) {
                charts.risk.data.datasets[0].data = [25, 25, 25, 25];
            } else {
                const toPct = v => Math.max(0, Math.round((v / total) * 100));
                let c = toPct(craterScore);
                let t = toPct(tsunamiScore);
                let s = toPct(seismicScore);
                let safe = Math.max(0, 100 - (c + t + s));
                const sumFinal = c + t + s + safe;
                if (sumFinal !== 100) {
                    safe = Math.max(0, 100 - (c + t + s));
                }
                charts.risk.data.datasets[0].data = [c, t, s, safe];
            }
            charts.risk.update('none');
        }

        // Working impact visualization update
        function updateImpactVisualization() {
            const craterDiameter = parseFloat(document.getElementById('craterValue').textContent);
            const tsunamiRadius = parseFloat(document.getElementById('tsunamiValue').textContent);
            
            // Update crater zone
            const craterZone = document.querySelector('.crater-zone');
            const craterSize = Math.max(20, craterDiameter * 50);
            craterZone.style.width = craterSize + 'px';
            craterZone.style.height = craterSize + 'px';
            
            // Update tsunami zone
            const tsunamiZone = document.querySelector('.tsunami-zone');
            const tsunamiSize = Math.max(50, tsunamiRadius * 5);
            tsunamiZone.style.width = tsunamiSize + 'px';
            tsunamiZone.style.height = tsunamiSize + 'px';
            
            // Update population density
            const populationDensity = document.querySelector('.population-density');
            const populationSize = Math.max(100, tsunamiRadius * 8);
            populationDensity.style.width = populationSize + 'px';
            populationDensity.style.height = populationSize + 'px';

            // Update Leaflet map overlays if initialized
            try {
                if (impactMap && craterCircle && tsunamiCircle && impactMarker) {
                    // Estimate impact lat/lng: keep static for now or compute from sliders later
                    const lat = 19.0760;
                    const lng = 72.8777;
                    const craterMeters = Math.max(1000, (craterDiameter / 2) * 1000); // radius in meters
                    const tsunamiMeters = Math.max(1000, tsunamiRadius * 1000);
                    impactMarker.setLatLng([lat, lng]);
                    craterCircle.setLatLng([lat, lng]);
                    tsunamiCircle.setLatLng([lat, lng]);
                    craterCircle.setRadius(craterMeters);
                    tsunamiCircle.setRadius(tsunamiMeters);
                }
            } catch {}
        }

                // Working deflection application
        function applyDeflection() {
            const method = currentDeflectionMethod;
            let deltaV = 0;
            let successProbability = 0;
            let cost = 0;
            
            if (method === 'kinetic') {
                const mass = parseFloat(document.getElementById('impactorMass').value);
                const velocity = parseFloat(document.getElementById('impactorVelocity').value);
                deltaV = (mass * velocity) / 1e12; // Simplified calculation
                successProbability = Math.min(0.92, 0.55 + deltaV * 400);
                cost = mass * 200; // toned down cost per kg
            } else if (method === 'gravity') {
                const mass = parseFloat(document.getElementById('tractorMass').value);
                const distance = parseFloat(document.getElementById('hoverDistance').value);
                deltaV = (mass / distance) * 0.001; // Simplified calculation
                successProbability = Math.min(0.88, 0.35 + deltaV * 3000);
                cost = mass * 500; // toned down cost per kg
            } else if (method === 'nuclear') {
                const yield = parseFloat(document.getElementById('nuclearYield').value);
                deltaV = Math.sqrt(yield) * 0.1; // Simplified calculation
                successProbability = Math.min(0.98, 0.8 + yield * 0.03);
                cost = yield * 250000; // toned down per MT
            }
            
            // Update policy brief
            document.getElementById('successProbability').textContent = (successProbability * 100).toFixed(0) + '%';
            document.getElementById('costEstimate').textContent = '$' + (cost / 1000000).toFixed(0) + 'M';
            
            // Update miss distance (simplified)
            const currentMiss = parseFloat(document.getElementById('missDistanceValue').textContent);
            const newMiss = currentMiss * (1 + deltaV * 10); // less aggressive sensitivity
            document.getElementById('missDistanceValue').textContent = newMiss.toFixed(0) + ' km';
            
            addToDataStream(`Deflection applied: ${method} - ${(successProbability * 100).toFixed(0)}% success, $${(cost/1000000).toFixed(0)}M cost`);
            // Recompute downstream values and refresh visuals/charts/risk
            calculateImpact();
            updateImpactVisualization();
            updatePolicyRecommendation();
        }

        // Working data stream functions
        function addToDataStream(message) {
            const stream = document.getElementById('dataStream');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.textContent = `${timestamp}: ${message}`;
            stream.appendChild(entry);
            stream.scrollTop = stream.scrollHeight;
            // Also announce for screen readers and show toast
            announceAria(message);
            showToast(message);
            
            // Keep only last 20 entries
            while (stream.children.length > 20) {
                stream.removeChild(stream.firstChild);
            }
        }

        function announceAria(msg) {
            const live = document.getElementById('ariaLive');
            if (!live) return;
            live.textContent = '';
            setTimeout(() => { live.textContent = msg; }, 30);
        }

        function showToast(msg) {
            const wrap = document.getElementById('toastContainer');
            if (!wrap) return;
            const el = document.createElement('div');
            el.className = 'toast';
            el.textContent = msg;
            wrap.appendChild(el);
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transition = 'opacity 300ms';
                setTimeout(() => wrap.removeChild(el), 350);
            }, 2500);
        }

        function startDataStream() {
            addToDataStream('Real-time data stream started');
            setInterval(() => {
                const timestamp = new Date().toLocaleTimeString();
                addToDataStream(`Live update: ${timestamp}`);
            }, 5000);
        }

        function persistState() {
            try {
                const state = {
                    a: document.getElementById('semiMajorAxis').value,
                    e: document.getElementById('eccentricity').value,
                    i: document.getElementById('inclination').value,
                    method: currentDeflectionMethod
                };
                localStorage.setItem('simState', JSON.stringify(state));
            } catch {}
        }

        function restoreState() {
            try {
                const raw = localStorage.getItem('simState');
                if (!raw) return;
                const state = JSON.parse(raw);
                if (state.a) document.getElementById('semiMajorAxis').value = state.a;
                if (state.e) document.getElementById('eccentricity').value = state.e;
                if (state.i) document.getElementById('inclination').value = state.i;
                if (state.method) currentDeflectionMethod = state.method;
            } catch {}
        }

        document.addEventListener('keydown', (e) => {
            if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
            if (e.key === 'd' || e.key === 'D') startDemoMode();
            if (e.key === 'f' || e.key === 'F') fetchRealData();
            if (e.key === 'h' || e.key === 'H') updateUncertaintyHeatmap();
            if (e.key === 'r' || e.key === 'R') resetSimulation();
        });

        function exportData() {
            const data = {
                timestamp: new Date().toISOString(),
                orbital_elements: {
                    semi_major_axis: document.getElementById('semiMajorValue').textContent,
                    eccentricity: document.getElementById('eccentricityValue').textContent,
                    inclination: document.getElementById('inclinationValue').textContent
                },
                impact_predictions: {
                    energy: document.getElementById('energyValue').textContent,
                    crater: document.getElementById('craterValue').textContent,
                    tsunami: document.getElementById('tsunamiValue').textContent
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'asteroid_simulation_data.json';
            a.click();
            URL.revokeObjectURL(url);
            
            addToDataStream('Data exported successfully');
        }

        async function fetchRealData() {
            if (isLoading) return;
            try {
                isLoading = true;
                const neoId = (document.getElementById('neoId').value || '').trim();
                const apiKey = 'DEMO_KEY';
                addToDataStream(`Fetching real data for NEO ${neoId || '(default)'}...`);

                const url = `https://api.nasa.gov/neo/rest/v1/neo/${encodeURIComponent(neoId)}?api_key=${encodeURIComponent(apiKey)}`;
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('NASA NEO fetch failed');
                const data = await resp.json();

                // Map orbital elements
                const orbital = data.orbital_data || {};
                const aAU = parseFloat(orbital.semi_major_axis);
                const ecc = parseFloat(orbital.eccentricity);
                const inc = parseFloat(orbital.inclination);
                if (Number.isFinite(aAU)) document.getElementById('semiMajorAxis').value = clamp(aAU, 0.5, 3);
                if (Number.isFinite(ecc)) document.getElementById('eccentricity').value = clamp(ecc, 0, 0.9);
                if (Number.isFinite(inc)) document.getElementById('inclination').value = clamp(inc, 0, 180);

                // Use first close-approach for velocity/miss distance if available
                const ca = Array.isArray(data.close_approach_data) && data.close_approach_data.length ? data.close_approach_data[0] : null;
                if (ca && ca.relative_velocity && ca.relative_velocity.kilometers_per_second) {
                    const v = parseFloat(ca.relative_velocity.kilometers_per_second);
                    if (Number.isFinite(v)) document.getElementById('velocityValue').textContent = v.toFixed(1) + ' km/s';
                }
                if (ca && ca.miss_distance && ca.miss_distance.kilometers) {
                    const missKm = parseFloat(ca.miss_distance.kilometers);
                    if (Number.isFinite(missKm)) document.getElementById('missDistanceValue').textContent = Math.round(missKm) + ' km';
                }

                updateOrbitalElements();
                addToDataStream('NASA NEO data loaded');
            } catch (err) {
                addToDataStream('Error: Failed to fetch NASA data');
            } finally {
                isLoading = false;
            }
        }

        function startDemoMode() {
            addToDataStream('Demo Mode: DART reference, uncertainty, and policy recommendation.');
            document.getElementById('semiMajorAxis').value = 1.7;
            document.getElementById('eccentricity').value = 0.35;
            document.getElementById('inclination').value = 22;
            updateOrbitalElements();
            updateUncertaintyHeatmap();
            updatePolicyRecommendation();
        }

        function updatePolicyRecommendation() {
            const e = parseFloat(document.getElementById('eccentricity').value);
            const i = parseFloat(document.getElementById('inclination').value);
            const a = parseFloat(document.getElementById('semiMajorAxis').value);
            const energyText = document.getElementById('energyValue').textContent || '0 MT TNT';
            const energyMt = Number.parseFloat(energyText);
            const missText = document.getElementById('missDistanceValue').textContent || '0';
            const missKm = Number.parseFloat(missText);
            const successText = document.getElementById('successProbability').textContent || '75%';
            const successPct = Math.max(0, Math.min(100, Number.parseFloat(successText)) || 75);

            // Estimate urgency from miss distance and a rough velocity derived from a
            const estVelocityKms = Math.max(0.1, a * 10);
            const timeSeconds = (Math.max(0, missKm) * 1000) / (estVelocityKms * 1000);
            const days = timeSeconds / 86400;

            // Composite risk score (0..1)
            const riskFromSuccess = 1 - (successPct / 100);
            const riskFromEnergy = Math.max(0, Math.min(1, (Number.isFinite(energyMt) ? energyMt : 0) / 1000));
            const riskFromProximity = Math.max(0, Math.min(1, (10000 - Math.max(0, missKm)) / 10000));
            const riskFromUrgency = Math.max(0, Math.min(1, (7 - Math.min(30, Math.max(0, days))) / 7));
            const score = 0.35 * riskFromSuccess + 0.30 * riskFromEnergy + 0.20 * riskFromProximity + 0.15 * riskFromUrgency;

            let risk = 'MEDIUM';
            if (score >= 0.6) risk = 'HIGH';
            else if (score < 0.3) risk = 'LOW';

            // Recommend using simple thresholds
            let recommendation = 'Kinetic Impactor';
            if (Number.isFinite(energyMt) && energyMt >= 1500 && days <= 7) {
                recommendation = 'Nuclear Standoff';
            } else if (days >= 45 && energyMt <= 300 && e <= 0.25 && i <= 25) {
                recommendation = 'Laser Ablation';
            } else if (days >= 25 && energyMt <= 600 && e <= 0.45) {
                recommendation = 'Gravity Tractor';
            } else if (i >= 50 && e >= 0.5 && days >= 10) {
                recommendation = 'Gravity Tractor + Kinetic';
            } else if (e <= 0.2 && i <= 20 && energyMt <= 900 && days >= 10) {
                recommendation = 'Kinetic Impactor (single mission)';
            }

            document.getElementById('recommendedAction').textContent = recommendation;
            document.getElementById('riskLevel').textContent = risk;
            // Keep shown success as-is if sourced from deflection; otherwise show nominal
            if (!successText) {
                document.getElementById('successProbability').textContent = (100 * (1 - riskFromSuccess)).toFixed(0) + '%';
            }
        }

        function updateUncertaintyHeatmap() {
            const heatmap = document.getElementById('uncertaintyHeatmap');
            if (!heatmap) return;
            const uncertainty = Math.random() * 0.5 + 0.3;
            heatmap.style.background = `radial-gradient(circle, rgba(255, 0, 0, ${uncertainty}) 0%, rgba(255, 165, 0, ${uncertainty * 0.7}) 50%, rgba(0, 255, 0, ${uncertainty * 0.3}) 100%)`;
            // Briefly boost opacity for visual feedback
            heatmap.style.transition = 'opacity 250ms ease-out';
            heatmap.style.opacity = '0.95';
            setTimeout(() => {
                heatmap.style.opacity = '0.7';
            }, 300);
            addToDataStream(`Uncertainty heatmap updated: ${(uncertainty * 100).toFixed(1)}%`);
        }

        function resetSimulation() {
            document.getElementById('semiMajorAxis').value = 1.5;
            document.getElementById('eccentricity').value = 0.3;
            document.getElementById('inclination').value = 15;
            updateOrbitalElements();
            addToDataStream('Simulation reset to default values');
        }

        // Working chart initialization
        function initializeCharts() {
            // Orbital Chart
            const orbitalCtx = document.getElementById('orbitalChart').getContext('2d');
            charts.orbital = new Chart(orbitalCtx, {
                type: 'line',
                data: {
                    labels: ['T-7d', 'T-6d', 'T-5d', 'T-4d', 'T-3d', 'T-2d', 'T-1d', 'T-0'],
                    datasets: [{
                        label: 'Distance (km)',
                        data: [1000000, 800000, 600000, 400000, 200000, 100000, 50000, 0],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    },
                    scales: {
                        x: { ticks: { color: 'white' } },
                        y: { ticks: { color: 'white' } }
                    }
                }
            });

            // Risk Chart
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            charts.risk = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Crater Zone', 'Tsunami Zone', 'Seismic Zone', 'Safe Zone'],
                    datasets: [{
                        data: [15, 25, 35, 25],
                        backgroundColor: ['#8B4513', '#ff6b6b', '#ffa500', '#4ecdc4']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    }
                }
            });
        }

        // Initialize Leaflet map and overlays
        let impactMap, craterCircle, tsunamiCircle, impactMarker;
        function initializeImpactMap() {
            try {
                impactMap = L.map('impactMap').setView([19.0760, 72.8777], 5);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: '© OpenStreetMap'
                }).addTo(impactMap);
                impactMarker = L.marker([19.0760, 72.8777]).addTo(impactMap);
                craterCircle = L.circle([19.0760, 72.8777], { radius: 5000, color: '#8B4513', fillColor: '#8B4513', fillOpacity: 0.4 }).addTo(impactMap);
                tsunamiCircle = L.circle([19.0760, 72.8777], { radius: 20000, color: '#ff6b6b', fillColor: '#ff6b6b', fillOpacity: 0.25 }).addTo(impactMap);
            } catch {}
        }
    </script>
</body>
</html>